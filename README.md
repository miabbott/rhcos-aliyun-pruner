# rhcos-aliyun-pruner

```bash
$ ./main.py --help
usage: main.py [-h] [--dry-run] [--debug] [--filename FILENAME] [--log-to-file LOG_TO_FILE] release

positional arguments:
  release               OCP release to operate on

optional arguments:
  -h, --help            show this help message and exit
  --dry-run             Just print what would happen
  --debug, -d           Enable debug logging
  --filename FILENAME   Path to file where bootimage data can be recorded; will allow for faster execution if script is run multiple times
  --log-to-file LOG_TO_FILE
                        Filename to record all log output to
```

Run the script with i.e. `./main.py 4.10`

Should work with OCP 4.10 + 4.11

**NOTE**: Requires that the `ALIYUN_ACCESS_KEY_ID` and `ALIYUN_ACCESS_KEY_SECRET` environment variables are configured.

The Aliyun account provided should have write access to the images that are being queried.

Initial execution of this script may take a long, long time depending on the amount of builds made for a release.  (Estimated time for the first run against the current 4.10 builds is around 5 hrs)

By default, the script writes two files:

1. `deleted_images.json` as a record of all the images that were deleted from the cloud (path+filename configurable with `--filename`)
2. `aliyun_pruner.log` as a record of all the log messages generated by the script (path+filename configurable with `--log-to-file`)

If the script is run multiple times, it is advised to make the `deleted_images.json` file from previous runs made available, as it will cut down subsequent execution times. (Note, the JSON file is only written to/updated if the script completes successfully)

## Container Image

A container image is available at `quay.io/miabbott/rhcos-aliyun-pruner`

To run the container image:

`podman run quay.io/miabbott/rhcos-aliyun-pruner <options> <release>`

You'll have to provide the necessary environement variables to the container.  See the `podman-run` man page for more information about providing environment values.

For example:

`podman run --env-file aliyun_vars.txt quay.io/miabbott/rhcos-aliyun-pruner <options> <release>`

```bash
export ALIYUN_ACCESS_KEY_ID=...
export ALIYUN_ACCESS_KEY_SECRET=...
podman run -e ALIYUN_ACCESS_KEY_ID -e ALIYUN_ACCESS_KEY_SECRET quay.io/miabbott/rhcos-aliyun-pruner <options> <release>
```

Additionally, if you want to have access to the JSON file + log file generated by the script, it is recommened to mount in a directory from the host into the container and point the files to that directory:

`podman run --env-file aliyun_vars.txt -v $(pwd):/host:z quay.io/miabbott/rhcos-aliyun-pruner --filename /host/deleted_images.json --log-to-file /host/aliyun_pruner.log <options> <release>`

## What does this actually do?

1. Check the git history of the `openshift/installer` repo for the specified release branch (i.e. `release-4.10`, `release-4.11`) for any changes to the bootimage metadata in `data/data/coreos/rhcos.json`
2. Records the RHCOS build IDs and Aliyun images uploaded to the various regions found in the commit history from step 1.
3. Checks all the builds ever made for an RHCOS release (i.e. 4.10) by parsing builds.json for all the build IDs.
4. Checks each RHCOS build ID to see if a Aliyun images were uploaded and records those build IDs.
5. If a build ID was found in the `openshift/installer` commit history, apply a tag of `bootimage=true`. Otherwise apply the tag `bootimage=false`.
6. If an image is tagged with `bootimage=false`, mark the image private, and delete the image from the Aliyun region.
7. Once complete, the build IDs and affected images/regions are recorded in a JSON file that can be used as an input for subsequent runs.
